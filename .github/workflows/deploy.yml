name: Deploy to AWS EC2 via Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Configurar JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Build com Maven
      run: mvn clean package -DskipTests

    - name: Enviar JAR para EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        source: "target/teste-cicd-0.0.1-SNAPSHOT.jar"
        target: "~/teste_cicd/target/"

    - name: Clonar repositório no EC2 (caso o código não esteja lá)
      run: |
        ssh -i ${{ secrets.KEY }} ubuntu@${{ secrets.HOST }} << 'EOF'
          cd ~
          git clone https://github.com/seu-usuario/seu-repositorio.git teste_cicd || echo "Repositório já clonado"
        EOF

    - name: Deploy via SSH na EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          cd ~/teste_cicd
          docker-compose down
          docker-compose up -d --build
